# Build and Release Scripts

This directory contains scripts for building, releasing, and maintaining the application.

## Scripts Overview

- `generate_manifest.sh` / `generate_manifest.py` - Generate update manifests from GitHub Releases
- `generate-configs.sh` - Generate build configurations from `app-config.json`
- `generate-icons.sh` - Generate platform-specific icons from source image
- `create_dmg.sh` - Create macOS DMG installer
- `test_update_server.go` - Test update server functionality

---

## Icon Generation

### generate-icons.sh

Automatically generates platform-specific icon files from a single source image.

**Source File:** `build/icon.png` (recommended: 1024x1024 PNG)

**Generated Files:**
- macOS: `AppIcon.icns` (with @2x Retina versions)
- Windows: `icon.ico`, `icon_256.png`, `icon_16.png`
- Linux: Multiple PNG sizes (16, 32, 48, 64, 128, 256, 512)

**Requirements:**
- ImageMagick: `brew install imagemagick` (macOS)
- iconutil (macOS only, for .icns generation)

**Usage:**
```bash
./scripts/generate-icons.sh
```

**Output:** Files are generated in `.build/icons/` and copied to `build/` for compatibility.

**Documentation:** See [docs/ICON_GENERATION.md](../docs/ICON_GENERATION.md) for details.

---

## Update Manifest Generation

## Overview

The auto-update system requires a `manifest.json` file that contains:
- Version information
- Release notes
- Download URLs for each platform
- SHA256 checksums for verification
- File sizes

These scripts automate the generation of this manifest from your GitHub Releases.

## Scripts

### generate_manifest.sh (Bash)

A bash script for Unix-like systems (Linux, macOS).

**Requirements:**
- bash
- curl
- sha256sum (or shasum on macOS)
- grep, awk, sed

**Usage:**
```bash
./scripts/generate_manifest.sh <owner/repo> <version> [github_token]
```

**Examples:**
```bash
# Without GitHub token (subject to rate limits)
./scripts/generate_manifest.sh myorg/myapp v1.2.3

# With GitHub token (recommended)
./scripts/generate_manifest.sh myorg/myapp v1.2.3 ghp_xxxxxxxxxxxxx
```

### generate_manifest.py (Python)

A Python script for cross-platform compatibility.

**Requirements:**
- Python 3.6+
- requests library: `pip install requests`

**Usage:**
```bash
python scripts/generate_manifest.py <owner/repo> <version> [github_token]
```

**Examples:**
```bash
# Without GitHub token (subject to rate limits)
python scripts/generate_manifest.py myorg/myapp v1.2.3

# With GitHub token (recommended)
python scripts/generate_manifest.py myorg/myapp v1.2.3 ghp_xxxxxxxxxxxxx
```

## Output

Both scripts generate a `manifest.json` file in the current directory with the following structure:

```json
{
  "version": "1.2.3",
  "published_at": "2026-01-14T10:00:00Z",
  "release_notes": "## What's New\n- Feature A\n- Bug fix B",
  "assets": {
    "windows_amd64": {
      "url": "https://github.com/owner/repo/releases/download/v1.2.3/app_windows_amd64.zip",
      "size": 10485760,
      "checksum": "abc123...",
      "name": "app_windows_amd64.zip"
    },
    "linux_amd64": {
      "url": "https://github.com/owner/repo/releases/download/v1.2.3/app_linux_amd64.tar.gz",
      "size": 8388608,
      "checksum": "def456...",
      "name": "app_linux_amd64.tar.gz"
    },
    "darwin_amd64": {
      "url": "https://github.com/owner/repo/releases/download/v1.2.3/app_darwin_amd64.zip",
      "size": 9437184,
      "checksum": "ghi789...",
      "name": "app_darwin_amd64.zip"
    },
    "darwin_arm64": {
      "url": "https://github.com/owner/repo/releases/download/v1.2.3/app_darwin_arm64.zip",
      "size": 9437184,
      "checksum": "jkl012...",
      "name": "app_darwin_arm64.zip"
    }
  }
}
```

## Platform Naming Convention

The scripts expect GitHub Release assets to follow this naming convention:

```
{project_name}_{os}_{arch}.{extension}
```

Where:
- `{project_name}`: Your project name (derived from repository name)
- `{os}`: Operating system (`windows`, `linux`, `darwin`)
- `{arch}`: Architecture (`amd64`, `arm64`)
- `{extension}`: File extension (`.zip` for Windows/macOS, `.tar.gz` for Linux)

**Examples:**
- `myapp_windows_amd64.zip`
- `myapp_linux_amd64.tar.gz`
- `myapp_darwin_arm64.zip`

This naming convention is automatically generated by GoReleaser with the configuration in `build/.goreleaser.yaml`.

## Checksums

The scripts will:
1. First try to download the checksums file: `{project_name}_{version}_checksums.txt`
2. If found, extract checksums from this file (fast)
3. If not found, download each asset and calculate SHA256 (slower)

GoReleaser automatically generates the checksums file, so option 1 is typically used.

## GitHub Token

While a GitHub token is optional, it's **highly recommended** to avoid API rate limits:

1. Go to GitHub Settings → Developer settings → Personal access tokens
2. Generate a new token with `public_repo` scope (for public repositories)
3. Use the token when running the script

**Note:** Keep your token secure and never commit it to version control.

## Workflow Integration

### Manual Process

1. Create a new release on GitHub using GoReleaser:
   ```bash
   git tag v1.2.3
   git push origin v1.2.3
   goreleaser release
   ```

2. Generate the manifest:
   ```bash
   python scripts/generate_manifest.py owner/repo v1.2.3 $GITHUB_TOKEN
   ```

3. Upload `manifest.json` to your update server or GitHub Release

### Automated Process (CI/CD)

You can automate manifest generation in your CI/CD pipeline:

```yaml
# Example GitHub Actions workflow
- name: Generate manifest
  run: |
    python scripts/generate_manifest.py ${{ github.repository }} ${{ github.ref_name }} ${{ secrets.GITHUB_TOKEN }}
    
- name: Upload manifest to release
  uses: actions/upload-release-asset@v1
  with:
    upload_url: ${{ steps.create_release.outputs.upload_url }}
    asset_path: ./manifest.json
    asset_name: manifest.json
    asset_content_type: application/json
```

## Troubleshooting

### "Release not found" error
- Verify the version tag exists on GitHub
- Ensure you're using the correct repository format: `owner/repo`
- Check if the release is published (not draft)

### "Asset not found" warnings
- Verify your GoReleaser configuration generates assets with the expected naming convention
- Check that the release includes all platform builds

### Rate limit errors
- Use a GitHub token to increase rate limits
- Wait for the rate limit to reset (typically 1 hour)

### Checksum calculation is slow
- Ensure GoReleaser is configured to generate a checksums file
- Verify the checksums file is uploaded to the release

## Support

For issues or questions about the auto-update system, please refer to:
- Design document: `.kiro/specs/auto-update/design.md`
- Requirements document: `.kiro/specs/auto-update/requirements.md`
